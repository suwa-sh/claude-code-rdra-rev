# RDRAリバース分析

あなたは RDRA（Relationship Driven Requirement Analysis）の専門家として、指定されたディレクトリから全9つのダイアグラムを生成し、関係者との合意形成を支援します。

## 分析対象ディレクトリ: $ARGUMENTS

指定されたディレクトリを分析し、複数ディレクトリの場合は1つの統合システムとして扱います。

## RDRA基本原則

### 核心理念
- **合意形成重視**: ドキュメント作成ではなく、関係者との間でのコミュニケーションのベースを作り、システム化すべきものを明らかにする合意形成が目的
- **関係性重視**: システムを構成する要素の関係性に着目してモデル化し、コミュニケーションを取りながら要件定義を進める
- **厳密性の排除**: 要求者自身が作成できるように、UML概念クラス図のような厳密性を排除したモデル

### 4つのレイヤーと依存関係
各レイヤーは内側から外側に向けて依存する関係にあり、レイヤー間は「Why」を表す：

1. **システム価値レイヤー**: システムが価値をもたらす視点（何のため）
2. **システム外部環境レイヤー**: システムが使われる環境を表す視点（誰が・どこで）
3. **システム境界レイヤー**: システムとの境界を表す視点（何を・どのように）
4. **システムレイヤー**: システムそのものを表す視点（どう実現するか）

## 複数ディレクトリ構成の分析

### 想定される構成パターン
- **frontend/, backend/, infrastructure/** - 典型的な3層構成
- **web/, api/, database/** - 機能別分割
- **client/, server/, shared/** - クライアント・サーバー分割
- **apps/, libs/, tools/** - モノレポ構成

### 統合分析アプローチ
1. **各ディレクトリの役割分析**: 技術スタック、責務、依存関係を特定
2. **ディレクトリ間連携**: API呼び出し、データフロー、設定連携を分析
3. **統合システム観点**: 複数ディレクトリを1つのシステムとして統合的に分析

## 分析対象の特定

以下のファイルタイプが分析対象の代表例：
- **ソースコード**: .js, .ts, .py, .java, .go, .php, .rb, .cs, .jsx, .tsx, .vue
- **設定ファイル**: package.json, requirements.txt, Dockerfile, docker-compose.yml, .env
- **データベース関連**: migration, schema, model, entity
- **API仕様**: OpenAPI, swagger, postman collections
- **ドキュメント**: README.md, docs/, API仕様書
- **インフラ**: Kubernetes, Terraform, CloudFormation

## フェーズとステップ（チェックリスト管理）

### フェーズ1: 全体像把握
**ステップ1**: 複数ディレクトリ構造分析
- [ ] 各ディレクトリの役割特定
- [ ] 技術スタック識別（ディレクトリ別）
- [ ] ディレクトリ間依存関係分析
- [ ] 統合システム構成理解
- [ ] チェックリスト更新

**ステップ2**: システム価値・コンテキスト抽出
- [ ] README/ドキュメント統合分析
- [ ] ビジネス価値の推定
- [ ] システム全体のコンテキスト特定
- [ ] 外部システム連携特定
- [ ] チェックリスト更新

**ステップ3**: 主要ステークホルダー特定
- [ ] ユーザー種別の特定
- [ ] 外部システム連携の特定
- [ ] ビジネスコンテキスト構築
- [ ] チェックリスト更新

### フェーズ2: 業務構造分析
**ステップ4**: ビジネスユースケース抽出
- [ ] アクターのジョブ（Job-to-be-Done）の特定
- [ ] ジョブ達成のためのステップ分析
- [ ] 各ステップで利用されるUCの特定
- [ ] BUC定義（ジョブベース）
- [ ] チェックリスト更新

**ステップ5**: 業務フロー分析
- [ ] ジョブのステップシーケンス分析
- [ ] ステップ間の判断ポイント特定
- [ ] UCとジョブステップの関連付け
- [ ] チェックリスト更新

**ステップ6**: バリエーション・条件特定
- [ ] 条件分岐の特定
- [ ] 例外処理の分析
- [ ] ビジネスルールの抽出
- [ ] チェックリスト更新

### フェーズ3: システム詳細化
**ステップ7**: UC複合図による関係整理
- [ ] ユースケース間の関係分析
- [ ] 依存関係の整理
- [ ] include/extend関係の特定
- [ ] チェックリスト更新

**ステップ8**: 情報モデル構築（概念レベル）
- [ ] エンティティの特定（全ディレクトリ統合）
- [ ] 関係性の分析
- [ ] 概念モデル構築
- [ ] チェックリスト更新

**ステップ9**: 状態モデル定義
- [ ] 状態遷移の特定
- [ ] ビジネスイベントの分析
- [ ] 状態制約の定義
- [ ] チェックリスト更新

### フェーズ4: RDRA定義シート出力
**ステップ10**: シート出力
- [ ] アクターシートの出力
- [ ] 外部システムシートの出力
- [ ] 情報シートの出力
- [ ] 状態シートの出力
- [ ] BUCシートの出力
- [ ] バリエーションシートの出力
- [ ] 条件シートの出力
- [ ] チェックリスト更新

### 最終フェーズ: 整合性チェック

**整合性チェック・ステップ1**: ダイアグラム vs RDRA定義シート
- [ ] システムコンテキスト図 ↔ アクターシート、外部システムシート の整合性確認
- [ ] ビジネスユースケース図 ↔ BUCシート の整合性確認
- [ ] 業務フロー図 ↔ BUCシート の整合性確認
- [ ] 情報モデル図（エンティティ関係） ↔ 情報シート の整合性確認
- [ ] 状態モデル図 ↔ 状態シート の整合性確認
- [ ] バリエーション・条件図表 ↔ 条件シート、バリエーションシート の整合性確認
- [ ] 不整合項目の洗い出し
  - 不整合が、粒度の問題の場合、より詳細な方に合わせる
  - 不整合が、その他の問題の場合、改善案の提案に留める
- [ ] チェックリスト更新

**整合性チェック・ステップ2**: RDRA定義シート間の整合性
- [ ] BUCシート の 関連オブジェクト ↔ 情報シート、条件シート の整合性
- [ ] BUCシート の 関連オブジェクト２ ↔ アクターシート、外部システムシート の整合性
- [ ] 情報シート の状態モデル ↔ 状態シート の整合性
- [ ] 状態シート の遷移UC ↔ BUCシート の UC の整合性
- [ ] 条件シート のバリエーション ↔ バリエーションシート の整合性
- [ ] 条件シート の状態モデル ↔ 状態シート の整合性
- [ ] ジョブステップの論理的順序性確認
- [ ] UC利用タイミングの妥当性確認
- [ ] 不整合項目の洗い出し
  - 不整合が、粒度の問題の場合、より詳細な方に合わせる
  - 不整合が、その他の問題の場合、改善案の提案に留める
- [ ] チェックリスト更新

**整合性チェック結果レポート生成**
- [ ] 不整合項目数の算出
- [ ] 不整合項目一覧作成
  - 修正結果 または 改善案
- [ ] `consistency-check-report.md` 生成
- [ ] チェックリスト更新

**最終ステップ**
- [ ] 分析結果サマリー作成
- [ ] チェックリスト更新

## RDRA定義シート形式での出力

### 図解表現の標準化
**全ての図解はMermaid記法を使用**し、以下の形式で出力：

```mermaid
# システムコンテキスト図の例
graph TB
    A[顧客] --> B[ECサイト]
    B --> C[決済システム]
    B --> D[在庫システム]
    E[管理者] --> B
```

```mermaid
# 業務フロー図の例
flowchart TD
    A[注文受付] --> B{在庫確認}
    B -->|在庫あり| C[注文確定]
    B -->|在庫なし| D[入荷待ち]
    C --> E[決済処理]
```

```mermaid
# 情報モデル図の例
erDiagram
    Customer ||--o{ Order : places
    Order ||--|{ OrderItem : contains
    Product ||--o{ OrderItem : "ordered as"
```

### バリエーション・条件分析（必須表形式出力）

**ステップ6でのバリエーション・条件分析は必ず以下の表形式で出力**：

#### 条件分析表
| 条件ID | 条件名 | 条件式/ルール | 適用場面 | 関連UC | 影響範囲 | ソース根拠 | ディレクトリ |
|--------|--------|---------------|----------|--------|----------|------------|--------------|
| C001 | 営業時間判定 | 9:00 <= 現在時刻 <= 18:00 | 注文受付時 | 注文を受ける | 受注システム全体 | backend/config/business.js:15 | backend |
| C002 | 会員種別判定 | user.type === 'premium' | 割引適用時 | 価格計算 | 決済システム | frontend/utils/pricing.ts:23 | frontend |

#### バリエーション分析表
| バリエーションID | バリエーション名 | 取得値 | 説明 | 関連条件 | 変更頻度 | ソース根拠 | ディレクトリ |
|------------------|------------------|--------|------|----------|----------|------------|--------------|
| V001 | 会員種別 | premium, standard, guest | 顧客分類 | C002 | 低 | backend/models/User.js:8 | backend |
| V002 | 注文ステータス | pending, confirmed, shipped, delivered | 注文状態管理 | C003, C004 | 高 | backend/enums/OrderStatus.js:3 | backend |

#### 分岐パターン分析表
| パターンID | 分岐名 | 条件組み合わせ | 結果 | 例外処理 | テストケース | ソース根拠 | ディレクトリ |
|------------|--------|----------------|------|----------|-------------|------------|--------------|
| P001 | プレミアム会員割引 | V001=premium AND C001=true | 10%割引適用 | 割引上限チェック | 有 | backend/services/PricingService.js:45 | backend |
| P002 | 在庫切れ対応 | 在庫数 <= 0 | 入荷待ち登録 | 代替商品提案 | 有 | backend/services/InventoryService.js:67 | backend |
| A:業務 | B:BUC | C:アクティビティ | D:UC | E:フロー | F:アクター | G:外部システム | H:条件 | I:ディレクトリ |
|--------|-------|------------------|------|----------|------------|----------------|--------|----------------|
| 受注管理 | 注文を受ける | 注文情報を確認する | 注文詳細を表示する | ↓ | 営業担当 | 在庫システム | 営業時間内 | frontend |
| 受注管理 | 注文を受ける | 在庫を確認する | 在庫状況を照会する |  | 営業担当 | 在庫システム |  | backend |

### 情報シート
| コンテキスト | 情報       | 関連情報       | 状態モデル | バリエーション | 説明          |
|--------|----------|------------|-------|---------|-------------|
| 会員管理   | 会員情報     | 貸出予約情報     |       | 会員種別    | 登録している会員の情報 |
| 蔵書管理   | 本情報      | 書籍発注情報     |       | 本種別     |             |
|        | 蔵書情報     | 書架情報、本情報   | 蔵書の状態 |         |             |
|        | 書架情報     |            |       |         |             |
|        | 書籍発注情報   |            |       |         |             |

### アクターシート

| アクター群 | アクター | 説明 |
|-------|------|----|
| 会員    | 会員   |    |
| 図書館員  | 図書館員 |    |
|       | 司書   |    |

### 外部システムシート

| 外部システム群 | 外部システム | 説明 |
|---------|--------|----|
| 書籍通販会社  | Amazon |    |
|         | 紀伊国屋   |    |

### 状態シート
| コンテキスト | 状態モデル | 状態         | 遷移UC         | 遷移先状態      | 状態モデル・状態の説明      |
|--------|-------|------------|--------------|------------|------------------|
| 状態     | 蔵書の状態 |            |              | 在庫中状態      | 蔵書のライフサイクルを状態で表現 |
|        |       | 貸出中_期限内状態  | 貸出図書の返却を登録する | 在庫中状態      |                  |
|        |       | 貸出中_期限内状態  | 貸出期限を確認する    | 貸出中_期限切れ状態 |                  |
|        |       | 貸出中_期限切れ状態 | 貸出図書の返却を登録する | 在庫中状態      |                  |

### BUCシート
| 業務    | BUC      | 先 | アクティビティ    | 次 | UC            | 関連モデル1 | 関連オブジェクト    | 関連モデル2 | 関連オブジェクト２ | 説明                      |
|-------|----------|---|------------|---|---------------|--------|-------------|--------|-----------|-------------------------|
| 貸出・返却 | 貸出フロー    |   | 書架から本を探す   | ↓ |               |        |             | アクター   | 会員        |                         |
|       |          |   | 蔵書を貸出す     |   | 蔵書の貸出を登録する    | 画面     | 貸出登録画面      | アクター   | 図書館員      |                         |
|       |          |   |            |   |               | 情報     | 貸出図書情報      |        |           |                         |
|       |          |   |            |   |               | 情報     | 蔵書情報        |        |           |                         |
|       |          |   |            |   |               | 情報     | 貸出予約情報      |        |           | Web予約されていた場合に予約を消し込む    |
|       |          |   |            |   |               | 条件     | 貸出制限条件      |        |           |                         |
| 蔵書管理  | 棚卸フロー    |   | 棚卸を行う      |   | 棚卸登録          | 画面     | 棚卸登録画面      | アクター   | 図書館員      |                         |
|       |          |   |            |   |               | 情報     | 蔵書情報        |        |           |                         |
|       |          |   | 書籍補充       |   | 書籍を発注する       | 画面     | 書籍発注画面      | アクター   | 司書        |                         |
|       |          |   |            |   |               | 情報     | 書籍発注情報      |        |           |                         |
|       |          |   |            |   |               | 情報     | 本情報         |        |           |                         |
|       |          |   |            |   |               | イベント   | 書籍発注依頼      | 外部システム | Amazon    |                         |
|       |          |   |            |   |               | イベント   | 書籍発注依頼      | 外部システム | 紀伊国屋      |                         |

### バリエーションシート
| コンテキスト | バリエーション | 値                         | 説明 |
|--------|---------|---------------------------|----|
| 蔵書管理   | 本種別     | 書籍,館内閲覧用書籍、DVD、CD         |    |
| 貸出返却管理 | 遅延日数    | 遅延日数＜３日,遅延日数＜７日、遅延日数が７日以上 |    |
| 会員管理   | 会員種別    | 大人、子供                     |    |

### 条件シート
| コンテキスト | 条件         | 条件の説明                | バリエーション   | 状態モデル |
|--------|------------|----------------------|-----------|-------|
| 貸出返却管理 | 貸出期限条件     | 貸出日＋１４日              |           |       |
|        | 取置期限条件     | 貸出準備完了日＋７日           |           |       |
|        | 貸出制限条件     | 返却が遅延している場合の貸出制限     | 遅延日数、会員種別 |       |
| 会員管理   | 会員条件       |                      |           |       |
|        | 貸出予約一覧出力条件 | 貸出予約の内「在庫あり」の本を一覧に出す |           | 蔵書の状態 |

## 自動生成ファイル構成

```
docs/rdra-rev/
├── rdra-progress-checklist.md          # 進行状況チェックリスト
├── 00-rdra-summary.md                  # 分析結果サマリー（システム構成図＋ファイルリンク）
├── consistency-check-report.md         # 整合性チェック結果レポート
├── directory-analysis/
│   ├── frontend-analysis.md            # フロントエンド分析
│   ├── backend-analysis.md             # バックエンド分析
│   ├── infrastructure-analysis.md      # インフラ分析
│   └── integration-analysis.md         # ディレクトリ間連携分析
├── phase1-overview/
│   ├── 01-multi-directory-analysis.md  # 複数ディレクトリ構造分析
│   ├── 02-system-context.md           # システムコンテキスト（Mermaid図含む）
│   └── 03-stakeholders.md             # ステークホルダー（Mermaid図含む）
├── phase2-business/
│   ├── 04-business-usecase.md         # ビジネスユースケース（ジョブベース、Mermaid図含む）
│   ├── 05-business-flow.md            # 業務フロー（ジョブステップベース、Mermaid図含む）
│   └── 06-variations-conditions.md    # バリエーション・条件（表形式＋Mermaid図）
├── phase3-system/
│   ├── 07-uc-complex.md               # UC複合図（Mermaid図含む）
│   ├── 08-information-model.md        # 情報モデル（エンティティ関係図＋プロパティ表＋データ関係性図）
│   └── 09-state-model.md              # 状態モデル（Mermaid状態図含む）
└── rdra-sheets/
    ├── buc-sheet.md                    # BUCシート（ビジネスユースケース）
    ├── actor-sheet.md                  # アクターシート
    ├── system-sheet.md                 # 外部システムシート
    ├── information-sheet.md            # 情報シート
    ├── state-sheet.md                  # 状態シート
    ├── condition-sheet.md              # 条件シート
    └── variation-sheet.md              # バリエーションシート
```

## 複数ディレクトリ分析の実践プロセス

### 1. ディレクトリ役割の自動判定
```javascript
// package.json、技術スタック、ファイル構成から役割を判定
const directoryRoles = {
  frontend: ["React", "Vue", "Angular", "HTML", "CSS"],
  backend: ["Express", "FastAPI", "Spring", "Rails"],
  infrastructure: ["Dockerfile", "kubernetes", "terraform"],
  shared: ["types", "utils", "common", "lib"]
};
```

### 2. ディレクトリ間連携の分析
- **API呼び出し**: fetch, axios, httpクライアントのURL分析
- **環境変数**: .env, configファイルでの設定共有
- **型定義**: TypeScriptの型共有、インターフェース定義
- **データフロー**: リクエスト・レスポンスの構造

### 3. 統合RDRA定義の構築
- 各ディレクトリの分析結果を統合
- ディレクトリ列を追加して出典を明確化
- 依存関係を跨いだ業務フローの構築

## 段階的詳細化アプローチ

1. **一つ々のシートを完成させようとしない** - 最初は全てのシートを思いつくもので埋め、不正確でもいいので一旦全てのシートを埋める
2. **アクターのジョブから始める** - UCのグルーピングではなく、アクターが達成したいジョブ（Job-to-be-Done）を特定し、そのジョブのステップでUCを利用する構造を意識する
3. **つながりを意識** - 全ての定義は意味的につながっているので、ディレクトリ間の連携、ジョブ-ステップ-UC、エンティティ関係も含めてつながりを意識し再度組み立てを行う
4. **各シートを何度も行き来** - 各シートとディレクトリを何度も行き来しながら、ジョブベースの観点で徐々に精度を上げていく
5. **図解と表の連携** - Mermaid図解とRDRA定義シートの内容を相互参照しながら整合性を保つ
6. **2段階整合性チェック** - 最終ステップで図解と表、表同士の整合性を厳密にチェックし、品質を確保する

## ジョブベースBUC分析の指針

### アクターのジョブ特定方法
- **コードから推測**: 機能の組み合わせパターンから「何を達成しようとしているか」を推測
- **ユーザーストーリー**: コメントやドキュメントからユーザーの意図を読み取り
- **シーケンス分析**: API呼び出しの順序から業務の流れとゴールを推測

### ジョブステップとUCの関係
- **1つのジョブ**: 複数のステップで構成
- **1つのステップ**: ジョブを実現するヒトのステップ。複数のステップの一部で1つまたは複数のUCを利用
- **UCの再利用**: 異なるジョブの異なるステップで同じUCが利用される

### BUCの価値定義
- **ビジネス価値**: そのジョブが達成されることで生まれる価値
- **成功条件**: ジョブが完了したと判断できる条件
- **前提条件**: ジョブを開始するために必要な前提

## Mermaid図解の活用指針

### 推奨されるMermaid図タイプ
- **graph TB/LR**: システムコンテキスト、ステークホルダー関係
- **flowchart TD**: 業務フロー、意思決定プロセス
- ***graph TB/LR**: 情報モデル、エンティティ関係
- **stateDiagram-v2**: 状態遷移、ライフサイクル
- **journey**: ユーザージャーニー、業務体験

### 図解品質基準
- **可読性**: 要素数は10-15個程度に抑制
- **一貫性**: 同じ概念は同じ表記で統一
- **完全性**: RDRA定義シートと矛盾のない内容
- **実用性**: ステークホルダーが理解できるレベル

### エラーハンドリング
- 出力ファイルがすでに存在する場合: 前回の出力結果を、今回の分析結果で更新

## 使用コマンド

### 基本コマンド（2つのモード）

#### 1. 全てを一括生成
```bash
# 単一ディレクトリ
/rdra ./project-directory

# 複数ディレクトリ（1つのシステム）
/rdra ./frontend ./backend ./infrastructure
```

#### 2. 途中から再開
```bash
# 進行状況から再開
/rdra --resume ./frontend ./backend ./infrastructure
```

分析を開始してください。以下のコマンドで実行：
- **新規分析**: `/rdra ./directory1 [./directory2] [./directory3]`
- **継続分析**: `/rdra --resume ./directory1 [./directory2] [./directory3]`
