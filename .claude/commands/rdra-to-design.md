# RDRAリバース分析からの設計リバース分析 v0.2.0

rdraリバース分析の結果と実装から、設計ドキュメントをリバースで生成します。

引数: $ARGUMENTS

## コマンド解析

引数を解析して実行モードを決定：
- `--continue` が含まれる場合: 分析を再開（`--continue`を除いた残りをディレクトリパスとして扱う）
- それ以外: 新規分析を開始（すべての引数をディレクトリパスとして扱う）

## 実行モード判定と処理

### A. 再開モード（--continueが指定された場合）

#### 再開手順

 - `docs/rdra-to-design/checklist.md` を読み込んで現在の進捗を確認
 - 完了したタスクを識別
 - 未完了タスクをリストアップ
 - 再開すべきタスクを決定
 - 必要なファイルのみ読み込み
 - 中断したところから作業を継続
 - チェックリストを更新
 - 完了後、自動的に次のタスクへ

### B. 新規分析モード（--continueが指定されていない場合）

#### Phase 1: 初期準備
1. 指定されたディレクトリ群を軽くスキャンして規模と構造を把握
   - 引数のイメージ: ./docs/rdra-rev ./frontend ./backend ./infra
2. `docs/rdra-to-design/` ディレクトリを作成
3. `docs/rdra-to-design/checklist.md` でチェックリストを作成
4. 複数リポジトリの場合は相互関係も把握

#### Phase 2: チェックリスト作成

**チェックリスト（checklist.mdに記録）**
```markdown
# 分析進捗チェックリスト

## アーキテクチャ分析
- [ ] C4 システムコンテキスト図作成
   - RDRAシステムコンテキストを流用
- [ ] C4 コンテナ図作成
   - RDRAシステムコンテキストをドリルダウンして構成要素の関係を図解
   - mermaid graphを利用
   - 図解には説明を含めず、図ごとにテーブルで説明を記載
      - テーブルのレイアウト: 名前、説明
- [ ] C4 コンポーネント図作成
   - C4 コンテナ図の構成要素ごとにドリルダウンして図解
   - mermaid graphを利用
   - 図解には説明を含めず、図ごとにテーブルで説明を記載
      - テーブルのレイアウト: 名前、説明
- [ ] 物理構成図作成
   - Public Cloudのサービス、SaaS、ミドルウェアなどをどのように組み合わせているかを図解
   - C4 コンテナ図の物理的な側面
   - mermaid graphを利用
   - 図解には説明を含めず、図ごとにテーブルで説明を記載
      - テーブルのレイアウト: 名前、説明
- [ ] レイヤー構成の文書化
   - C4 コンテナ図の構成要素ごとにコードのレイヤー構造を図解
   - コードを責務でグルーピングしてレイヤーとして扱い、レイヤー間がどのように連携するのかを図解
   - mermaid graphを利用
   - 図解には説明を含めず、図ごとにテーブルで説明を記載
      - テーブルのレイアウト: 名前、説明
- [ ] チェックリストを更新

## ドメイン分析
- [ ] 概念モデル図作成
   - RDRA 情報シートの情報カラムを利用
   - 情報同士がどのように関連するかを図解
   - mermaid graphを利用
   - 図解には説明を含めず、図ごとにテーブルで説明を記載
      - テーブルのレイアウト: 名前、説明
- [ ] エンティティ、集約、値オブジェクトを抽出
- [ ] 境界づけられたコンテキストを図解
  - mermaid graphでコンテキスト間のつながりを図解
  - コンテキストごとのエンティティ、責務、外部依存を列挙
- [ ] 境界づけられたコンテキストごとのドメインモデル図作成
  - 想定される具体値をもたせたオブジェクト図
  - mermaid classDiagramで、具体値を記載
    - 型ではなく具体値を記載
    - {}や()文法エラーなので、除去した文字列で記載
    - ER図ではなくクラス図での多重度の記法を利用
  - NG:

     ```
     class User {
        id: string
        email: string
        metadata: {department: "営業部"}
        tags: ["VIP", "Premium(PR)"]
     }
     User ||--o{ OAuthToken
     ```

  - OK:

     ```
     class User {
        id "clerk_user_456"
        email "tanaka@example.com"
        metadata "department:営業部"
        tags "VIP,Premium PR"
     }
     User "1" --> "*" OAuthToken : owns
     ```

- [ ] チェックリストを更新

## 機能分析
- [ ] ユースケース一覧作成
   - ユースケース、エントリーポイント、処理概要 を持つテーブル
   - RDRA BUCシートのUCを総量とする
   - エントリーポイントが存在しない場合、`エントリーポイントなし`と記載
- [ ] ユースケースごとにシーケンス図を作成
   - エントリーポイントからのメソッドレベルの処理フローを図解
   - mermaidを利用
- [ ] チェックリストを更新

## 環境構築分析
- [ ] ローカル環境セットアップ手順作成
- [ ] テスト環境セットアップ手順作成
- [ ] 本番環境セットアップ手順作成
- [ ] チェックリストを更新

## テスト分析
- [ ] テスト戦略作成
- [ ] テスト手順作成
- [ ] CIパイプライン説明
- [ ] チェックリストを更新

## デプロイ分析
- [ ] 環境一覧作成
   - 環境、サービス、URLを持つテーブル
   - サービスは利用する外部サービス（public cloud, SaaSなど）
- [ ] デプロイ手順作成
- [ ] CDパイプライン説明
- [ ] チェックリストを更新

## 運用分析
- [ ] モニタリング手順作成
   - メトリクス、ロギング、トレーシングそれぞれの確認方法
- [ ] 定期的な作業作成
   - 月次、四半期ごと、半年ごと、年ごとなどで実行が必要な手順
- [ ] 不定期な作業作成
   - バージョンアップの取り込みなど不定期で必要な手順
- [ ] 障害対応手順作成
   - 障害が発生した場合の、検知、問題切り分けからfix版のデプロイ、解消判断の手順
- [ ] チェックリストを更新

## 整合性確認と修正
- [ ] 完全性チェック
   - 作成したファイルを読み返して、記載が不足していることはないか？
   - 不足している場合、追加
- [ ] 内部整合性チェック
   - 作成したファイル間で整合性が保たれているか？
   - 保たれていない場合、修正案を整理
   - 複数の修正案がある場合、パターンを整理して記載
   - 修正案が1つの場合、修正を実施、修正結果を記載
- [ ] 用語一貫性チェック
   - 作成したファイル間で用語が統一されているか？
   - 統一されていない場合、修正案を整理
   - 複数の修正案がある場合、パターンを整理して記載
   - 修正案が1つの場合、修正を実施、修正結果を記載
- [ ] 図表整合性チェック
   - 作成した図解間で整合性が保たれているか？
   - 保たれていない場合、修正案を整理
   - 複数の修正案がある場合、パターンを整理して記載
   - 修正案が1つの場合、修正を実施、修正結果を記載
- [ ] チェックリストを更新

## サマリーファイル生成
- [ ] 作成したすべてのドキュメントへのリンク
- [ ] チェックリストを更新
```

#### Phase 3: 段階的分析実施

- チェックリストの対象項目の指示に従って分析を実施
- 完了したチェックリストを更新

## 出力ファイル構成
```
rdra-to-design/
├── checklist.md               # 進捗チェックリスト（常に最初に読み込む）
├── 01-summary.md              # サマリー
├── 02-repository-structure.md # リポジトリ構造
├── 03-architecture.md         # アーキテクチャ
├── 04-domain-model.md         # ドメインモデル
├── 05-features.md             # 機能分析
├── 06-environments.md         # 環境構築
├── 07-tests.md                # テスト
├── 08-deploy.md               # デプロイ
├── 09-ops.md                  # 運用
├── 10-validation-report.md    # 整合性確認結果
└── rdra-to-design.md          # サマリー
```
