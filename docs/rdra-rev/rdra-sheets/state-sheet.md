# 状態シート

## 図書館管理システムの状態定義

### 状態シート

| コンテキスト | 状態モデル | 状態 | 遷移UC | 遷移先状態 | 状態モデル・状態の説明 |
|--------|-------|------------|--------------|------------|------------------|
| 蔵書管理 | 所蔵品の状態 | 未登録 | 所蔵品を登録する | 在庫中 | 所蔵品のライフサイクルを状態で表現。物理的な資料の管理状態を示す。 |
| 蔵書管理 | 所蔵品の状態 | 在庫中 | 貸出を登録する | 貸出中 | 図書館内にあり、利用可能な状態 |
| 蔵書管理 | 所蔵品の状態 | 在庫中 | 予約を受け付ける | 予約中 | 他の所蔵品が全て貸出中の場合の予約待ち状態 |
| 蔵書管理 | 所蔵品の状態 | 在庫中 | 取置を登録する | 取置中 | 予約者のために準備された状態 |
| 蔵書管理 | 所蔵品の状態 | 貸出中 | 返却を登録する | 在庫中 | 利用者に貸出されている状態 |
| 蔵書管理 | 所蔵品の状態 | 予約中 | 取置を登録する | 取置中 | 予約により確保されている状態 |
| 蔵書管理 | 所蔵品の状態 | 予約中 | 予約をキャンセルする | 在庫中 | 予約が取り消された場合 |
| 蔵書管理 | 所蔵品の状態 | 取置中 | 取置貸出を実行する | 貸出中 | 予約者への貸出実行 |
| 蔵書管理 | 所蔵品の状態 | 取置中 | 取置期限切れを処理する | 在庫中 | 取置期限切れによる解放 |
| 蔵書管理 | 所蔵品の状態 | 在庫中 | 除籍処理を実行する | その他 | 廃棄・紛失等の特殊処理 |
| 蔵書管理 | 所蔵品の状態 | 貸出中 | 紛失報告を受け付ける | その他 | 貸出中の紛失処理 |
| 貸出管理 | 貸出の状態 | 貸出中_期限内 | 返却を登録する | 返却済 | 貸出のライフサイクルを管理。期限内の正常な貸出状態 |
| 貸出管理 | 貸出の状態 | 貸出中_期限内 | 期限経過を確認する | 貸出中_延滞 | 返却期限の自動チェック |
| 貸出管理 | 貸出の状態 | 貸出中_延滞 | 返却を登録する | 返却済 | 期限超過による延滞状態 |
| 貸出管理 | 貸出の状態 | 貸出中_延滞 | 督促通知を送信する | 貸出中_延滞 | 延滞者への督促処理（状態維持） |
| 予約管理 | 予約の状態 | 未準備 | 取置を登録する | 消込済 | 予約の進行状況を管理。予約受付後の準備待ち状態 |
| 予約管理 | 予約の状態 | 未準備 | 予約をキャンセルする | 消込済 | 予約者による取り消し |
| 予約管理 | 予約の状態 | 未準備 | 即時貸出を実行する | 消込済 | 在庫があった場合の即座な貸出 |
| 会員管理 | 会員の状態 | 未登録 | 会員登録を実行する | 有効 | 会員資格のライフサイクル。システム初期状態 |
| 会員管理 | 会員の状態 | 有効 | 資格停止を実行する | 無効 | 正常な会員資格状態 |
| 会員管理 | 会員の状態 | 無効 | 資格回復を実行する | 有効 | 制裁・問題による資格停止状態 |

### 状態モデル詳細定義

#### 所蔵品の状態モデル

**目的**: 物理的な資料（図書・視聴覚資料）の利用可能性と所在を管理

**状態定義**:

| 状態名 | 状態コード | 説明 | 滞在期間 | 前提条件 | 終了条件 |
|--------|-----------|------|----------|----------|----------|
| 未登録 | UNREGISTERED | システム未登録状態 | 資料受入まで | 物理的存在 | 登録手続き完了 |
| 在庫中 | AVAILABLE | 利用可能状態 | 利用まで | 図書館内所在 | 貸出・予約・除籍 |
| 貸出中 | ON_LOAN | 貸出状態 | 返却まで | 有効な貸出記録 | 返却・紛失報告 |
| 予約中 | RESERVED | 予約待ち状態 | 取置準備まで | 予約記録存在 | 取置・キャンセル |
| 取置中 | RETAINED | 取置状態 | 貸出・期限切れまで | 取置記録存在 | 貸出・期限切れ |
| その他 | OTHER | 特殊状態 | 除籍まで | 廃棄・紛失等 | 除籍処理 |

**状態遷移ルール**:
- 未登録 → 在庫中: 必須（資料受入時）
- 在庫中 ⇄ 貸出中: 双方向（貸出・返却）
- 在庫中 → 予約中: 条件付き（他所蔵品が全て貸出中）
- 在庫中 → 取置中: 条件付き（予約からの取置準備）
- 予約中 → 取置中: 必須（返却により準備可能）
- 取置中 → 貸出中: 条件付き（予約者来館）
- 取置中 → 在庫中: 自動（期限切れ）

**業務制約**:
- 同時に複数の状態は持てない
- 貸出中の資料は新規貸出不可
- 取置中の資料は他者への貸出不可
- その他状態からの復帰は除籍・再登録が必要

#### 貸出の状態モデル

**目的**: 貸出記録の進行状況と期限管理

**状態定義**:

| 状態名 | 状態コード | 説明 | 滞在期間 | 前提条件 | 終了条件 |
|--------|-----------|------|----------|----------|----------|
| 貸出中_期限内 | ON_LOAN_NORMAL | 期限内貸出 | 期限日まで | 有効な貸出 | 返却・期限経過 |
| 貸出中_延滞 | ON_LOAN_OVERDUE | 延滞貸出 | 返却まで | 期限経過 | 返却 |
| 返却済 | RETURNED | 貸出終了 | 永続 | 返却処理完了 | なし（終端状態） |

**状態遷移ルール**:
- 貸出中_期限内 → 返却済: 期限内返却
- 貸出中_期限内 → 貸出中_延滞: 自動（期限経過）
- 貸出中_延滞 → 返却済: 遅延返却
- 返却済からの遷移なし（終端状態）

**業務制約**:
- 期限経過は日次バッチで自動実行
- 延滞状態では督促処理が発動
- 返却済み状態は変更不可

#### 予約の状態モデル

**目的**: 予約処理の進行状況管理

**状態定義**:

| 状態名 | 状態コード | 説明 | 滞在期間 | 前提条件 | 終了条件 |
|--------|-----------|------|----------|----------|----------|
| 未準備 | NOT_PREPARED | 処理待ち | 処理完了まで | 予約登録完了 | 取置・キャンセル・即時貸出 |
| 消込済 | COMPLETED | 処理完了 | 永続 | 処理実行完了 | なし（終端状態） |

**状態遷移ルール**:
- 未準備 → 消込済: 取置準備・キャンセル・即時貸出
- 消込済からの遷移なし（終端状態）

**業務制約**:
- 未準備状態では待ち順序で優先度管理
- 消込済み後の処理変更不可

#### 会員の状態モデル

**目的**: 会員資格の有効性管理

**状態定義**:

| 状態名 | 状態コード | 説明 | 滞在期間 | 前提条件 | 終了条件 |
|--------|-----------|------|----------|----------|----------|
| 未登録 | UNREGISTERED | 登録前状態 | 登録まで | なし | 会員登録 |
| 有効 | ACTIVE | 正常会員 | 問題発生・退会まで | 登録手続き完了 | 資格停止・退会 |
| 無効 | INACTIVE | 資格停止 | 回復・退会まで | 制裁措置 | 資格回復・退会 |

**状態遷移ルール**:
- 未登録 → 有効: 新規登録時
- 有効 ⇄ 無効: 双方向（停止・回復）
- 有効・無効 → 終了: 退会処理

**業務制約**:
- 有効会員のみサービス利用可能
- 無効会員は資格回復まで利用制限
- 退会後の復帰は新規登録扱い

### 状態監視・制御

#### 自動状態遷移

| 状態モデル | 遷移タイミング | 遷移条件 | 実行方式 | 頻度 |
|------------|----------------|----------|----------|------|
| 貸出の状態 | 期限経過時 | 現在日付 > 返却期限日 | 日次バッチ | 毎日1回 |
| 所蔵品の状態 | 取置期限切れ | 現在日付 > 取置期限日 | 日次バッチ | 毎日1回 |
| 会員の状態 | 有効期限切れ | 現在日付 > 会員有効期限 | 日次バッチ | 毎日1回 |

#### 状態整合性チェック

| チェック項目 | 対象状態 | チェック条件 | 不整合時処理 | 実行頻度 |
|-------------|----------|-------------|-------------|----------|
| 貸出-所蔵品整合性 | 貸出中 ⇔ 所蔵品貸出中 | 状態の一致 | 状態同期・アラート | リアルタイム |
| 予約-取置整合性 | 予約消込済 ⇔ 取置存在 | 関連の確認 | データ修復 | 日次 |
| 会員-利用整合性 | 無効会員の利用記録 | 制限違反確認 | 利用停止処理 | リアルタイム |

#### 状態遷移ログ

**記録内容**:
```json
{
  "timestamp": "2025-07-06T10:30:00Z",
  "entity_type": "所蔵品",
  "entity_id": "BOOK001",
  "from_state": "在庫中",
  "to_state": "貸出中",
  "trigger_uc": "貸出を登録する",
  "actor": "司書A",
  "context": {
    "member_id": "M123",
    "loan_id": "L456"
  }
}
```

**保存期間**: 3年（監査要件）
**用途**: 監査、分析、問題調査

### 状態遷移パフォーマンス

#### 遷移処理時間目標

| 状態モデル | 遷移種別 | 目標時間 | 現在値 | 改善目標 |
|------------|----------|----------|--------|----------|
| 所蔵品の状態 | 貸出実行 | <2秒 | 1.2秒 | 良好 |
| 所蔵品の状態 | 返却実行 | <1秒 | 0.8秒 | 良好 |
| 貸出の状態 | 期限確認 | <5秒 | 3.2秒 | 良好 |
| 予約の状態 | 取置処理 | <3秒 | 2.1秒 | 良好 |
| 会員の状態 | 登録処理 | <10秒 | 8.5秒 | 良好 |

#### バッチ処理性能

| バッチ処理 | 対象件数 | 処理時間目標 | 現在値 | 実行時間帯 |
|------------|----------|-------------|--------|------------|
| 期限切れ確認 | ~1000件 | <10分 | 7分 | 深夜2:00 |
| 取置期限切れ | ~50件 | <2分 | 1.5分 | 深夜2:30 |
| 状態整合性チェック | 全件 | <30分 | 22分 | 深夜3:00 |

### 状態モデル進化計画

#### 短期的拡張（6ヶ月以内）

| 拡張項目 | 内容 | 目的 | 影響範囲 |
|----------|------|------|----------|
| 延長状態追加 | 貸出期間延長の状態管理 | 利便性向上 | 貸出の状態 |
| 予約優先度 | VIP会員等の優先処理 | サービス差別化 | 予約の状態 |
| メンテナンス状態 | 資料の修理・整備期間 | 資料管理向上 | 所蔵品の状態 |

#### 中期的拡張（1年以内）

| 拡張項目 | 内容 | 目的 | 影響範囲 |
|----------|------|------|----------|
| デジタル資料状態 | 電子書籍のライセンス管理 | デジタル化対応 | 新状態モデル |
| 複数館連携状態 | 他館貸出の状態管理 | サービス拡張 | 所蔵品の状態 |
| 自動督促状態 | 督促レベルの段階管理 | 督促業務効率化 | 貸出の状態 |

#### 長期的拡張（2年以内）

| 拡張項目 | 内容 | 目的 | 影響範囲 |
|----------|------|------|----------|
| AIレコメンド状態 | 推薦による予約状態 | パーソナライゼーション | 予約の状態 |
| IoT連携状態 | RFID等による自動状態更新 | 自動化推進 | 所蔵品の状態 |
| 予測分析状態 | 需要予測による事前準備 | 運営最適化 | 新状態モデル |

この状態シート分析により、図書館管理システムの動的な振る舞いが体系化され、安定した状態管理と将来拡張の基盤が構築された。