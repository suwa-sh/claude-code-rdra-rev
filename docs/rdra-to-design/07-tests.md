# ãƒ†ã‚¹ãƒˆåˆ†ææ›¸

## 1. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1.1 ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰

```mermaid
graph TB
    subgraph "ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰"
        E2E[E2Eãƒ†ã‚¹ãƒˆ<br/>çµåˆãƒ†ã‚¹ãƒˆ<br/>30%]
        INT[çµ±åˆãƒ†ã‚¹ãƒˆ<br/>Serviceå±¤ãƒ†ã‚¹ãƒˆ<br/>50%]
        UNIT[å˜ä½“ãƒ†ã‚¹ãƒˆ<br/>Domainå±¤ãƒ†ã‚¹ãƒˆ<br/>70%]
    end
    
    UNIT --> INT
    INT --> E2E
```

### 1.2 ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã¨ç¯„å›²

| ãƒ†ã‚¹ãƒˆç¨®åˆ¥ | å¯¾è±¡ç¯„å›² | ç›®çš„ | å®Ÿè¡Œé »åº¦ | å®Ÿè£…çŠ¶æ³ |
|-----------|---------|------|---------|----------|
| å˜ä½“ãƒ†ã‚¹ãƒˆ | ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« | ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«æ¤œè¨¼ | æ¯å› | âœ…å®Ÿè£…æ¸ˆã¿ |
| çµ±åˆãƒ†ã‚¹ãƒˆ | ã‚µãƒ¼ãƒ“ã‚¹å±¤ | ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ¤œè¨¼ | æ¯å› | âœ…å®Ÿè£…æ¸ˆã¿ |
| ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ | æ¥­å‹™ãƒ•ãƒ­ãƒ¼æ¤œè¨¼ | æ¯å› | âœ…å®Ÿè£…æ¸ˆã¿ |
| E2Eãƒ†ã‚¹ãƒˆ | UIå«ã‚€å…¨ä½“ | ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–ç‚¹ | ãƒªãƒªãƒ¼ã‚¹å‰ | ğŸ”„æœªå®Ÿè£… |

### 1.3 ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®ç‰¹å¾´

#### ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•ãƒ†ã‚¹ãƒˆ
- ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’ä¸­å¿ƒã¨ã—ãŸãƒ†ã‚¹ãƒˆè¨­è¨ˆ
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®å˜ä½“ãƒ†ã‚¹ãƒˆã‚’é‡è¦–
- å®Ÿéš›ã®ãƒ“ã‚¸ãƒã‚¹è¦ä»¶ã«åŸºã¥ããƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
- H2ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨
- ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æŠ•å…¥ãƒ»å‰Šé™¤
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

#### ã‚·ãƒŠãƒªã‚ªãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
- å®Ÿéš›ã®æ¥­å‹™ãƒ•ãƒ­ãƒ¼ã«åŸºã¥ããƒ†ã‚¹ãƒˆ
- è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ„ã¿åˆã‚ã›ãŸãƒ†ã‚¹ãƒˆ
- ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚‚å«ã‚€åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆ

## 2. ãƒ†ã‚¹ãƒˆæ‰‹é †

### 2.1 å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆDomainå±¤ï¼‰

#### å®Ÿè¡Œæ–¹æ³•
```bash
# ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./gradlew test --tests "library.domain.**"
```

#### ä¸»è¦ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹
| ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ | å¯¾è±¡ | ãƒ†ã‚¹ãƒˆå†…å®¹ |
|-------------|------|----------|
| `DueDateTest` | è¿”å´æœŸé™ | æœŸé™è¶…éåˆ¤å®šã€å»¶æ»æ—¥æ•°è¨ˆç®— |
| `DuesTest` | å»¶æ»çŠ¶æ³ | å»¶æ»ãƒ¬ãƒ™ãƒ«åˆ¤å®šã€åˆ¶é™é©ç”¨ |
| `RestrictionTest` | è²¸å‡ºåˆ¶é™ | åˆ¶é™ãƒ«ãƒ¼ãƒ«é©ç”¨ã€å¯å¦åˆ¤å®š |

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¾‹
```java
@Test
void è¿”å´æœŸé™ã‚’è¶…éã—ã¦ã„ã‚‹å ´åˆã¯å»¶æ»() {
    DueDate dueDate = new DueDate(LocalDate.now().minusDays(1));
    
    assertThat(dueDate.isOverdue()).isTrue();
}
```

### 2.2 çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆServiceå±¤ï¼‰

#### å®Ÿè¡Œæ–¹æ³•
```bash
# ã‚µãƒ¼ãƒ“ã‚¹å±¤ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./gradlew test --tests "library.application.service.**"
```

#### ä¸»è¦ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹
| ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ | å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ | ãƒ†ã‚¹ãƒˆå†…å®¹ |
|-------------|-------------|----------|
| `LoanQueryServiceTest` | è²¸å‡ºç…§ä¼š | è²¸å‡ºå¯å¦åˆ¤å®šã€åˆ¶é™ç¢ºèª |
| `LoanRecordServiceTest` | è²¸å‡ºè¨˜éŒ² | è²¸å‡ºç™»éŒ²ã€çŠ¶æ…‹æ›´æ–° |
| `ReservationQueryServiceTest` | äºˆç´„ç…§ä¼š | äºˆç´„å¯å¦åˆ¤å®šã€å¾…ã¡é †åº |
| `ReservationRecordServiceTest` | äºˆç´„è¨˜éŒ² | äºˆç´„ç™»éŒ²ã€çŠ¶æ…‹ç®¡ç† |

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆç‰¹å¾´
```java
@Test
@Transactional
void ä¼šå“¡ã®è²¸å‡ºå¯èƒ½å†Šæ•°ã‚’ç¢ºèªã§ãã‚‹() {
    // Given: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
    MemberNumber memberNumber = new MemberNumber("001");
    
    // When: ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè¡Œ
    Loanability result = loanQueryService.findLoanabilityOf(memberNumber);
    
    // Then: çµæœæ¤œè¨¼
    assertThat(result).isEqualTo(Loanability.å¯èƒ½);
}
```

### 2.3 ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆï¼ˆæ¥­å‹™ãƒ•ãƒ­ãƒ¼ï¼‰

#### å®Ÿè¡Œæ–¹æ³•
```bash
# ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./gradlew test --tests "library.application.scenario.**"
```

#### ä¸»è¦ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹
| ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ | å¯¾è±¡ã‚·ãƒŠãƒªã‚ª | ãƒ†ã‚¹ãƒˆå†…å®¹ |
|-------------|-------------|----------|
| `LoanScenarioTest` | è²¸å‡ºã‚·ãƒŠãƒªã‚ª | è²¸å‡ºæ¥­å‹™å…¨ä½“ãƒ•ãƒ­ãƒ¼ |
| `ReservationScenarioTest` | äºˆç´„ã‚·ãƒŠãƒªã‚ª | äºˆç´„æ¥­å‹™å…¨ä½“ãƒ•ãƒ­ãƒ¼ |
| `RetentionScenarioTest` | å–ç½®ã‚·ãƒŠãƒªã‚ª | å–ç½®æ¥­å‹™å…¨ä½“ãƒ•ãƒ­ãƒ¼ |
| `ReturnsScenarioTest` | è¿”å´ã‚·ãƒŠãƒªã‚ª | è¿”å´æ¥­å‹™å…¨ä½“ãƒ•ãƒ­ãƒ¼ |

#### æ¥­å‹™ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆä¾‹
```java
@Test
void è²¸å‡ºã‹ã‚‰è¿”å´ã¾ã§ã®å®Œå…¨ãªãƒ•ãƒ­ãƒ¼() {
    // 1. è²¸å‡ºå®Ÿè¡Œ
    LoanRequest loanRequest = new LoanRequest(memberNumber, itemNumber, loanDate);
    loanScenario.loanBook(loanRequest);
    
    // 2. è¿”å´å®Ÿè¡Œ
    Returned returned = new Returned(itemNumber, returnDate);
    returnsScenario.returned(returned);
    
    // 3. çŠ¶æ…‹ç¢ºèª
    assertThat(itemQueryService.findBy(itemNumber).çŠ¶æ…‹()).isEqualTo(ItemStatus.åœ¨åº«ä¸­);
}
```

### 2.4 çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆControllerå±¤ï¼‰

#### å®Ÿè¡Œæ–¹æ³•
```bash
# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./gradlew test --tests "library.presentation.**"
```

#### ä¸»è¦ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹
| ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ | å¯¾è±¡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© | ãƒ†ã‚¹ãƒˆå†…å®¹ |
|-------------|-----------------|----------|
| `LoanRegisterControllerTest` | è²¸å‡ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© | HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ |
| `ReservationControllerTest` | äºˆç´„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© | ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã€ç”»é¢é·ç§» |
| `RetentionControllerTest` | å–ç½®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© | CRUDæ“ä½œã€çŠ¶æ…‹ç®¡ç† |

#### Webãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ†ã‚¹ãƒˆä¾‹
```java
@Test
void è²¸å‡ºãƒ•ã‚©ãƒ¼ãƒ ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹() throws Exception {
    mockMvc.perform(get("/loan/register"))
        .andExpect(status().isOk())
        .andExpect(view().name("loan/form"))
        .andExpect(model().attributeExists("loanForm"));
}
```

## 3. CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### 3.1 GitHub Actionsæ§‹æˆ

```yaml
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
    
    - name: Run tests
      run: ./gradlew test
    
    - name: Generate test report
      run: ./gradlew jacocoTestReport
    
    - name: SonarCloud analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: ./gradlew sonar
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
```

### 3.2 å“è³ªã‚²ãƒ¼ãƒˆ

| æŒ‡æ¨™ | é–¾å€¤ | ç”¨é€” |
|------|------|------|
| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | 80%ä»¥ä¸Š | ã‚³ãƒ¼ãƒ‰å“è³ªä¿è¨¼ |
| ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ | 100% | æ©Ÿèƒ½å®‰å®šæ€§ä¿è¨¼ |
| SonarQubeå“è³ªè©•ä¾¡ | Aè©•ä¾¡ | ä¿å®ˆæ€§ä¿è¨¼ |
| ãƒ“ãƒ«ãƒ‰æ™‚é–“ | 5åˆ†ä»¥å†… | é–‹ç™ºåŠ¹ç‡æ€§ |

### 3.3 ãƒ†ã‚¹ãƒˆç’°å¢ƒ

#### ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
```yaml
# application-test.yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;MODE=PostgreSQL;DB_CLOSE_DELAY=-1
  sql:
    init:
      mode: always
```

#### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç®¡ç†
- `src/test/resources/data.sql`: ãƒ†ã‚¹ãƒˆç”¨åˆæœŸãƒ‡ãƒ¼ã‚¿
- å„ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã§ç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
- ãƒ†ã‚¹ãƒˆé–“ã§ã®ãƒ‡ãƒ¼ã‚¿å¹²æ¸‰ã‚’é˜²æ­¢

## 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ãƒ¬ãƒãƒ¼ãƒˆ

### 4.1 ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

| ã‚³ãƒãƒ³ãƒ‰ | ç”¨é€” | å‡ºåŠ› |
|---------|------|------|
| `./gradlew test` | å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ | `build/reports/tests/` |
| `./gradlew jacocoTestReport` | ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ | `build/reports/jacoco/` |
| `./gradlew sonar` | SonarQubeè§£æ | SonarCloud |
| `./gradlew jigReports` | è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | `build/jig/` |

### 4.2 ç¶™ç¶šçš„å“è³ªæ”¹å–„

#### ãƒ†ã‚¹ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¨ç§»
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“æ¨ç§»
- ãƒ†ã‚¹ãƒˆå¤±æ•—ç‡æ¨ç§»
- å“è³ªå•é¡Œæ¤œå‡ºæ•°æ¨ç§»

#### å®šæœŸçš„ãªè¦‹ç›´ã—
- æœˆæ¬¡: ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ãƒ¬ãƒ“ãƒ¥ãƒ¼
- å››åŠæœŸ: ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ ãƒ»å‰Šé™¤
- åŠå¹´: ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–æ‹¡å¼µ
- å¹´æ¬¡: ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«è©•ä¾¡ãƒ»æ›´æ–°

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ›´æ–°

- [x] ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ä½œæˆ
- [x] ãƒ†ã‚¹ãƒˆæ‰‹é †ä½œæˆ
- [x] CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³èª¬æ˜